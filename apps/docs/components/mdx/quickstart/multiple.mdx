<section id="server">

```ts tab="Next.js" title="app/api/upload/route.ts"
import { route, type Router } from '@better-upload/server';
import { toRouteHandler } from '@better-upload/server/adapters/next';
import { aws } from '@better-upload/server/clients';

const router: Router = {
  client: aws(), // or cloudflare(), backblaze(), tigris(), ... // [!code highlight]
  bucketName: 'my-bucket', // [!code highlight]
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
    }),
  },
};

export const { POST } = toRouteHandler(router);
```

```ts tab="TanStack Start" title="routes/api/upload.ts"
import { createFileRoute } from '@tanstack/react-router';
import { handleRequest, route, type Router } from '@better-upload/server';
import { aws } from '@better-upload/server/clients';

const router: Router = {
  client: aws(), // or cloudflare(), backblaze(), tigris(), ... // [!code highlight]
  bucketName: 'my-bucket', // [!code highlight]
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
    }),
  },
};

export const Route = createFileRoute('/api/upload')({
  server: {
    handlers: {
      POST: async ({ request }) => {
        return handleRequest(request, router);
      },
    },
  },
});
```

```ts tab="Remix" title="app/routes/api.upload.ts"
import { ActionFunctionArgs } from '@remix-run/node';
import { handleRequest, route, type Router } from '@better-upload/server';
import { aws } from '@better-upload/server/clients';

const router: Router = {
  client: aws(), // or cloudflare(), backblaze(), tigris(), ... // [!code highlight]
  bucketName: 'my-bucket', // [!code highlight]
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
    }),
  },
};

export async function action({ request }: ActionFunctionArgs) {
  return handleRequest(request, router);
}
```

```ts tab="Hono"
// when using a separate backend server, make sure to update the `api` option on the client hooks.

import { Hono } from 'hono';
import { handleRequest, route, type Router } from '@better-upload/server';
import { aws } from '@better-upload/server/clients';

const router: Router = {
  client: aws(), // or cloudflare(), backblaze(), tigris(), ... // [!code highlight]
  bucketName: 'my-bucket', // [!code highlight]
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
    }),
  },
};

const app = new Hono();

app.post('/upload', (c) => {
  return handleRequest(c.req.raw, router);
});

export default app;
```

```ts tab="Elysia"
// when using a separate backend server, make sure to update the `api` option on the client hooks.

import { Elysia } from 'elysia';
import { handleRequest, route, type Router } from '@better-upload/server';
import { aws } from '@better-upload/server/clients';

const router: Router = {
  client: aws(), // or cloudflare(), backblaze(), tigris(), ... // [!code highlight]
  bucketName: 'my-bucket', // [!code highlight]
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
    }),
  },
};

const app = new Elysia()
  .post('/upload', ({ request }) => {
    return handleRequest(request, router);
  })
  .listen(3000);
```

```ts tab="Express"
// when using a separate backend server, make sure to update the `api` option on the client hooks.

import express from 'express';
import { route, type Router } from '@better-upload/server';
import { toNodeHandler } from '@better-upload/server/adapters/node';
import { aws } from '@better-upload/server/clients';

const router: Router = {
  client: aws(), // or cloudflare(), backblaze(), tigris(), ... // [!code highlight]
  bucketName: 'my-bucket', // [!code highlight]
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
    }),
  },
};

const app = express();

app.post('/upload', toNodeHandler(router));

// only mount express json middleware AFTER upload router
app.use(express.json());

app.listen(3000);
```

```ts tab="Fastify"
// when using a separate backend server, make sure to update the `api` option on the client hooks.

import Fastify from 'fastify';
import { route, type Router } from '@better-upload/server';
import { toNodeHandler } from '@better-upload/server/adapters/node';
import { aws } from '@better-upload/server/clients';

const router: Router = {
  client: aws(), // or cloudflare(), backblaze(), tigris(), ... // [!code highlight]
  bucketName: 'my-bucket', // [!code highlight]
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
    }),
  },
};

const app = Fastify();

app.post('/upload', toNodeHandler(router));

app.listen({ port: 3000 });
```

</section>

<section id="server-accordions">

<Accordions>
<Accordion title="Adding authentication">

You can run code before uploads in the server. Use the `onBeforeUpload` callback:

```ts
import { RejectUpload, route, type Router } from '@better-upload/server';
import { aws } from '@better-upload/server/clients';

const auth = (req: Request) => ({ id: 'fake-user-id' }); // [!code highlight]

const router: Router = {
  client: aws(),
  bucketName: 'my-bucket',
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
      // [!code ++:7]
      onBeforeUpload: async ({ req, files, clientMetadata }) => {
        const user = await auth(req);

        if (!user) {
          throw new RejectUpload('Not logged in!');
        }
      },
    }),
  },
};
```

</Accordion>
<Accordion title="Modifying S3 object info">

You can modify the S3 object through the `onBeforeUpload` callback:

```ts
const router: Router = {
  client: aws(),
  bucketName: 'my-bucket',
  routes: {
    images: route({
      fileTypes: ['image/*'],
      multipleFiles: true,
      maxFiles: 4,
      // [!code ++:10]
      onBeforeUpload: async ({ req, files, clientMetadata }) => {
        return {
          generateObjectInfo: ({ file }) => ({
            key: `files/${file.name}`,
            metadata: {
              author: 'user_123',
            },
          }),
        };
      },
    }),
  },
};
```

</Accordion>

<Accordion title="Available S3 clients">

There are built-in clients for popular S3-compatible services. Suggest a new client by [opening an issue](https://github.com/Nic13Gamer/better-upload/issues).

<include>../helpers-server.mdx#s3-clients</include>

</Accordion>
</Accordions>

</section>
